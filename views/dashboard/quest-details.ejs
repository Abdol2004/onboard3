<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - ONBOARD3</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/dashboard.css">
    <style>
        .modal {
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            animation: slideUp 0.3s ease-out;
        }
      
        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .close-btn:hover {
            background: rgba(255,255,255,0.1) !important;
            color: #fff !important;
            transform: rotate(90deg);
        }
        
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 1rem;
            background: rgba(15,15,15,0.95);
            border: 1px solid rgba(57,255,20,0.2);
            border-radius: 12px;
            color: #fff;
            font-size: 0.95rem;
            transition: all 0.3s;
            font-family: 'Space Grotesk', sans-serif;
        }
        
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #39FF14;
            box-shadow: 0 0 0 3px rgba(57,255,20,0.1);
        }
        
        .form-group label {
            color: #39FF14;
            margin-bottom: 0.6rem;
            display: block;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .leaderboard-row:hover {
            background: rgba(255,255,255,0.05) !important;
            transform: translateX(5px);
        }

        #leaderboardList::-webkit-scrollbar {
            width: 8px;
        }

        #leaderboardList::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
        }

        #leaderboardList::-webkit-scrollbar-thumb {
            background: rgba(57,255,20,0.3);
            border-radius: 10px;
        }

        #leaderboardList::-webkit-scrollbar-thumb:hover {
            background: rgba(57,255,20,0.5);
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            /* Top 3 Podium - Stack on mobile */
            .podium-container {
                display: grid;
                grid-template-columns: 1fr !important;
                gap: 0.8rem !important;
                margin-bottom: 1.5rem;
                padding: 0.8rem !important;
            }

            .podium-item {
                padding: 1rem !important;
            }

            .podium-item .podium-rank {
                font-size: 1.5rem !important;
            }

            /* Task boxes - Better mobile layout */
            .quest-task {
                padding: 1rem !important;
                margin-bottom: 0.8rem !important;
            }

            .quest-task .task-header {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 0.8rem !important;
            }

            .quest-task .task-title-row {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 0.5rem !important;
                width: 100%;
            }

            .quest-task h4 {
                font-size: 0.95rem !important;
            }

            .quest-task .status-badge {
                align-self: flex-start !important;
                margin-top: 0 !important;
            }

            .quest-task .task-actions {
                flex-direction: column !important;
                width: 100%;
                gap: 0.8rem !important;
            }

            .quest-task .task-actions .btn {
                width: 100% !important;
                justify-content: center;
            }

            /* Leaderboard search */
            .leaderboard-header {
                flex-direction: column !important;
                align-items: stretch !important;
            }

            .leaderboard-search {
                max-width: 100% !important;
                margin-top: 1rem;
            }

            /* Leaderboard rows - Compact on mobile */
            .leaderboard-row {
                padding: 0.6rem 0.8rem !important;
                gap: 0.5rem !important;
            }

            .leaderboard-row .rank {
                min-width: 30px !important;
                font-size: 0.85rem !important;
            }

            .leaderboard-row .user-info {
                font-size: 0.85rem !important;
            }

            .leaderboard-row .user-meta {
                font-size: 0.7rem !important;
            }

            .leaderboard-row .xp-info {
                font-size: 0.9rem !important;
            }

            /* Header stats - Stack on mobile */
            .header-stats {
                flex-wrap: wrap !important;
                gap: 0.5rem !important;
            }

            .stat-badge {
                font-size: 0.85rem !important;
                padding: 0.5rem 0.8rem !important;
            }

            /* Modal - Full screen on small devices */
            .modal-content {
                width: 95% !important;
                max-width: 95% !important;
                padding: 1.5rem !important;
                margin: 1rem;
            }

            .modal-header h3 {
                font-size: 1.1rem !important;
            }

            /* Grid layouts */
            .grid-3 {
                grid-template-columns: 1fr !important;
                gap: 0.8rem !important;
            }

            /* Quest info badges */
            .quest-info-badges {
                flex-direction: column !important;
                gap: 0.8rem !important;
            }

            .quest-info-badges > div {
                width: 100% !important;
            }
        }

        @media (max-width: 480px) {
            /* Extra small screens */
            .quest-task {
                padding: 0.8rem !important;
            }

            .quest-task h4 {
                font-size: 0.9rem !important;
            }

            .quest-task p {
                font-size: 0.8rem !important;
            }

            .leaderboard-row {
                padding: 0.5rem 0.6rem !important;
            }

            .podium-item {
                padding: 0.8rem !important;
            }
        }

    </style>
</head>
<body>
    <div class="grid-bg"></div>
    
    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="sidebar-logo">
                <h1>ONBOARD3</h1>
                <p>Web3 Builder Hub</p>
            </div>

            <nav class="sidebar-menu">
                <a href="/dashboard" class="menu-item">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                <a href="/dashboard/quests" class="menu-item active">
                    <i class="fas fa-trophy"></i>
                    <span>Quests</span>
                </a>
                <a href="/dashboard/learn" class="menu-item">
                    <i class="fas fa-graduation-cap"></i>
                    <span>Learn</span>
                </a>
                 <a href="/dashboard/referral" class="menu-item">
                    <i class="fas fa-users"></i>
                    <span>Referral</span>
                </a>
                <a href="/dashboard/events" class="menu-item">
                    <i class="fas fa-calendar"></i>
                    <span>Events</span>
                </a>
                <a href="/dashboard/settings" class="menu-item">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </nav>

            <div class="sidebar-footer">
                <p>v1.0 ‚Äî Powered by</p>
                <p class="version">ONBOARD3</p>
            </div>
        </aside>

        <main class="main-content">
           <header class="header">
    <div class="header-content">
        <div class="header-title">
            <a href="/dashboard/quests" style="color: #39FF14; text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; font-size: 0.9rem;">
                <i class="fas fa-arrow-left"></i> Back to Quests
            </a>
            <h2><%= quest.title %></h2>
            <p><%= quest.shortDescription %></p>
            
            <!-- Quest Type Badge -->
            <% if (quest.questType && quest.questType !== 'standard') { %>
            <div style="margin-top: 0.8rem;">
                <% if (quest.questType === 'referral_boost') { %>
                    <span style="background: rgba(57,255,20,0.1); color: #39FF14; padding: 0.4rem 1rem; border-radius: 20px; font-size: 0.85rem; border: 1px solid #39FF14;">
                        üéÅ Referral Boost Quest - Earn bonus XP from your referrals!
                    </span>
                <% } else if (quest.questType === 'fcfs') { %>
                    <span style="background: rgba(255,193,7,0.1); color: #FFC107; padding: 0.4rem 1rem; border-radius: 20px; font-size: 0.85rem; border: 1px solid #FFC107;">
                        ‚ö° First Come First Serve - Be in the top <%= quest.competitionConfig?.topWinnersCount || 10 %>!
                    </span>
                <% } else if (quest.questType === 'competition') { %>
                    <span style="background: rgba(255,82,82,0.1); color: #ff5252; padding: 0.4rem 1rem; border-radius: 20px; font-size: 0.85rem; border: 1px solid #ff5252;">
                        üèÜ Competition Mode - Top <%= quest.competitionConfig?.topWinnersCount || 10 %> get bonus rewards!
                    </span>
                <% } %>
            </div>
            <% } %>
        </div>
        <div class="header-stats">
            <!-- Show XP Breakdown if quest is completed -->
            <% if (userProgress.status === 'completed' && userProgress.xpBreakdown) { %>
                <div class="stat-badge" style="background: rgba(57,255,20,0.1); border: 1px solid #39FF14;">
                    <i class="fas fa-trophy" style="color: #39FF14;"></i>
                    <span style="color: #39FF14;"><%= userProgress.xpBreakdown.totalXp %> Total XP</span>
                </div>
            <% } else { %>
                <div class="stat-badge">
                    <i class="fas fa-star" style="color: #39FF14;"></i>
                    <span><%= quest.baseXpReward || quest.xpReward || 0 %> XP</span>
                </div>
            <% } %>
            
            <% if (quest.usdcReward > 0) { %>
            <div class="stat-badge">
                <i class="fas fa-coins" style="color: #39FF14;"></i>
                <span><%= quest.usdcReward %> USDC</span>
            </div>
            <% } %>
            
            <div class="stat-badge">
                <i class="fas fa-tasks" style="color: #39FF14;"></i>
                <span><%= userProgress.tasksCompleted %>/<%= quest.tasks.length %> Tasks</span>
            </div>
            
            <!-- Show user's rank if quest is completed -->
            <% if (userProgress.status === 'completed' && userProgress.leaderboardRank) { %>
            <div class="stat-badge" style="background: rgba(255,193,7,0.1); border: 1px solid #FFC107;">
                <i class="fas fa-medal" style="color: #FFC107;"></i>
                <span style="color: #FFC107;">Rank #<%= userProgress.leaderboardRank %></span>
            </div>
            <% } %>
        </div>
    </div>
</header>

<!-- Add XP Breakdown Card for Completed Quests -->
<% if (userProgress.status === 'completed' && userProgress.xpBreakdown) { %>
<div class="card" style="background: linear-gradient(135deg, rgba(57,255,20,0.1) 0%, rgba(0,0,0,0.4) 100%); border: 2px solid #39FF14;">
    <div class="card-header">
        <h3><i class="fas fa-trophy"></i> Quest Completed! - XP Breakdown</h3>
    </div>
    
    <div class="grid-3" style="margin-bottom: 1rem;">
        <div style="text-align: center; padding: 1rem; background: rgba(57,255,20,0.1); border-radius: 12px; border: 1px solid #39FF14;">
            <div style="font-size: 2rem; color: #39FF14; font-weight: 700;"><%= userProgress.xpBreakdown.totalXp %></div>
            <div style="color: #888; font-size: 0.85rem;">Total XP Earned</div>
        </div>
        
        <% if (userProgress.leaderboardRank) { %>
        <div style="text-align: center; padding: 1rem; background: rgba(255,193,7,0.1); border-radius: 12px; border: 1px solid #FFC107;">
            <div style="font-size: 2rem; color: #FFC107; font-weight: 700;">#<%= userProgress.leaderboardRank %></div>
            <div style="color: #888; font-size: 0.85rem;">Your Rank</div>
        </div>
        <% } %>
        
        <div style="text-align: center; padding: 1rem; background: rgba(57,255,20,0.1); border-radius: 12px; border: 1px solid #39FF14;">
            <div style="font-size: 2rem; color: #39FF14; font-weight: 700;"><%= userProgress.timeSpentMinutes %></div>
            <div style="color: #888; font-size: 0.85rem;">Minutes</div>
        </div>
    </div>
    
    <!-- XP Sources Breakdown -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
        <div style="padding: 1rem; background: rgba(0,0,0,0.3); border-radius: 8px;">
            <div style="color: #888; font-size: 0.85rem; margin-bottom: 0.3rem;">Task Completion XP</div>
            <div style="color: #39FF14; font-size: 1.3rem; font-weight: 700;"><%= userProgress.xpBreakdown.taskXp %> XP</div>
        </div>
        
        <div style="padding: 1rem; background: rgba(0,0,0,0.3); border-radius: 8px;">
            <div style="color: #888; font-size: 0.85rem; margin-bottom: 0.3rem;">Quest Completion XP</div>
            <div style="color: #39FF14; font-size: 1.3rem; font-weight: 700;"><%= userProgress.xpBreakdown.baseXp %> XP</div>
        </div>
        
        <% if (userProgress.xpBreakdown.referralJoinBonus > 0) { %>
        <div style="padding: 1rem; background: rgba(0,0,0,0.3); border-radius: 8px;">
            <div style="color: #888; font-size: 0.85rem; margin-bottom: 0.3rem;">Referral Join Bonus</div>
            <div style="color: #39FF14; font-size: 1.3rem; font-weight: 700;"><%= userProgress.xpBreakdown.referralJoinBonus %> XP</div>
            <small style="color: #666;">(<%= userProgress.referralStats?.referralsJoined?.length || 0 %> joined)</small>
        </div>
        <% } %>
        
        <% if (userProgress.xpBreakdown.referralCompleteBonus > 0) { %>
        <div style="padding: 1rem; background: rgba(0,0,0,0.3); border-radius: 8px;">
            <div style="color: #888; font-size: 0.85rem; margin-bottom: 0.3rem;">Referral Complete Bonus</div>
            <div style="color: #39FF14; font-size: 1.3rem; font-weight: 700;"><%= userProgress.xpBreakdown.referralCompleteBonus %> XP</div>
            <small style="color: #666;">(<%= userProgress.referralStats?.referralsCompleted?.length || 0 %> completed)</small>
        </div>
        <% } %>
        
        <% if (userProgress.xpBreakdown.winnerBonus > 0) { %>
        <div style="padding: 1rem; background: rgba(255,193,7,0.1); border-radius: 8px; border: 1px solid #FFC107;">
            <div style="color: #FFC107; font-size: 0.85rem; margin-bottom: 0.3rem;">üèÜ Winner Bonus</div>
            <div style="color: #FFC107; font-size: 1.3rem; font-weight: 700;"><%= userProgress.xpBreakdown.winnerBonus %> XP</div>
        </div>
        <% } %>
    </div>
</div>
<% } %>

                <!-- Quest Description -->
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-info-circle"></i> Quest Description</h3>
                    </div>
                    <p style="color: #ccc; line-height: 1.6; margin-bottom: 1rem;">
                        <%= quest.description %>
                    </p>
                    <div class="quest-info-badges" style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1.5rem;">
                        <div style="background: rgba(57,255,20,0.1); padding: 0.8rem 1.2rem; border-radius: 12px; border: 1px solid rgba(57,255,20,0.3);">
                            <div style="color: #888; font-size: 0.75rem; margin-bottom: 0.3rem;">Difficulty</div>
                            <div style="color: #39FF14; font-weight: 600; text-transform: capitalize;"><%= quest.difficulty %></div>
                        </div>
                        <div style="background: rgba(57,255,20,0.1); padding: 0.8rem 1.2rem; border-radius: 12px; border: 1px solid rgba(57,255,20,0.3);">
                            <div style="color: #888; font-size: 0.75rem; margin-bottom: 0.3rem;">Duration</div>
                            <div style="color: #39FF14; font-weight: 600;"><%= quest.estimatedDuration %></div>
                        </div>
                        <div style="background: rgba(57,255,20,0.1); padding: 0.8rem 1.2rem; border-radius: 12px; border: 1px solid rgba(57,255,20,0.3);">
                            <div style="color: #888; font-size: 0.75rem; margin-bottom: 0.3rem;">Category</div>
                            <div style="color: #39FF14; font-weight: 600; text-transform: capitalize;"><%= quest.category %></div>
                        </div>
                    </div>
                </div>

                <!-- Quest Tasks -->
<div class="card">
    <div class="card-header">
        <h3><i class="fas fa-tasks"></i> Quest Tasks</h3>
    </div>

    <% quest.tasks.forEach(function(task, index) { 
        var taskProgress = userProgress.taskProgress.find(function(tp) { return tp.taskId.toString() === task._id.toString(); });
        var isCompleted = taskProgress && taskProgress.isCompleted;
        var isPreviousCompleted = index === 0 || userProgress.taskProgress[index - 1]?.isCompleted;
        var isLocked = !isPreviousCompleted && !isCompleted;
        var taskXp = task.xpReward || 0;
    %>

    <% if (isCompleted) { %>
    <!-- Completed Task -->
    <div class="quest-task completed" style="background: rgba(57,255,20,0.05); padding: 1.2rem; border-radius: 12px; margin-bottom: 1rem; border-left: 3px solid #39FF14;">
        <div class="task-header" style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.8rem;">
            <div style="flex: 1;">
                <div class="task-title-row" style="display: flex; align-items: center; gap: 0.8rem; margin-bottom: 0.5rem; flex-wrap: wrap;">
                    <span style="color: #39FF14; font-size: 1.2rem;"><i class="fas fa-check-circle"></i></span>
                    <h4 style="font-size: 1rem; color: #39FF14; margin: 0;">Task <%= index + 1 %>: <%= task.title %></h4>
                    <% if (taskXp > 0) { %>
                        <span style="background: rgba(57,255,20,0.2); color: #39FF14; padding: 0.3rem 0.7rem; border-radius: 12px; font-size: 0.75rem; border: 1px solid #39FF14;">
                            ‚úì +<%= taskXp %> XP
                        </span>
                    <% } %>
                </div>
                <p style="color: #888; font-size: 0.85rem; line-height: 1.5; margin: 0;"><%= task.description %></p>
            </div>
            <span class="status-badge status-approved" style="margin-top: 0; white-space: nowrap;">‚úì Completed</span>
        </div>
        <div style="color: #666; font-size: 0.8rem;">
            <i class="fas fa-clock"></i> Completed <%= new Date(taskProgress.completedAt).toLocaleString() %>
            <% if (taskProgress.xpEarned > 0) { %>
                <span style="margin-left: 1rem;">
                    <i class="fas fa-star" style="color: #39FF14;"></i> Earned <%= taskProgress.xpEarned %> XP
                </span>
            <% } %>
        </div>
    </div>
    
    <% } else if (isLocked) { %>
    <!-- Locked Task -->
    <div class="quest-task locked" style="background: rgba(255,255,255,0.02); padding: 1.2rem; border-radius: 12px; margin-bottom: 1rem; border-left: 3px solid #666; opacity: 0.6;">
        <div class="task-header" style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.8rem;">
            <div style="flex: 1;">
                <div class="task-title-row" style="display: flex; align-items: center; gap: 0.8rem; margin-bottom: 0.5rem; flex-wrap: wrap;">
                    <span style="color: #666; font-size: 1.2rem;"><i class="fas fa-lock"></i></span>
                    <h4 style="font-size: 1rem; color: #888; margin: 0;">Task <%= index + 1 %>: <%= task.title %></h4>
                    <% if (taskXp > 0) { %>
                        <span style="background: rgba(100,100,100,0.2); color: #666; padding: 0.3rem 0.7rem; border-radius: 12px; font-size: 0.75rem;">
                            +<%= taskXp %> XP
                        </span>
                    <% } %>
                </div>
                <p style="color: #666; font-size: 0.85rem; line-height: 1.5; margin: 0;"><%= task.description %></p>
            </div>
            <span class="status-badge" style="background: rgba(100,100,100,0.2); color: #666; margin-top: 0; white-space: nowrap;">üîí Locked</span>
        </div>
        <div style="background: rgba(255,193,7,0.1); padding: 0.6rem; border-radius: 8px; margin-top: 0.8rem;">
            <p style="color: #FFC107; font-size: 0.8rem; margin: 0;"><i class="fas fa-info-circle"></i> Complete Task <%= index %> to unlock this task</p>
        </div>
    </div>
    
    <% } else { %>
    <!-- Active Task -->
    <div class="quest-task active" style="background: rgba(255,255,255,0.05); padding: 1.2rem; border-radius: 12px; margin-bottom: 1rem; border-left: 3px solid #FFC107;">
        <div class="task-header" style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.8rem;">
            <div style="flex: 1;">
                <div class="task-title-row" style="display: flex; align-items: center; gap: 0.8rem; margin-bottom: 0.5rem; flex-wrap: wrap;">
                    <span style="color: #FFC107; font-size: 1.2rem;"><i class="fas fa-play-circle"></i></span>
                    <h4 style="font-size: 1rem; margin: 0;">Task <%= index + 1 %>: <%= task.title %></h4>
                    <% if (taskXp > 0) { %>
                        <span style="background: rgba(255,193,7,0.1); color: #FFC107; padding: 0.3rem 0.7rem; border-radius: 12px; font-size: 0.75rem; border: 1px solid #FFC107;">
                            +<%= taskXp %> XP
                        </span>
                    <% } %>
                </div>
                <p style="color: #888; font-size: 0.85rem; line-height: 1.5; margin-bottom: 1rem;"><%= task.description %></p>
            </div>
            <span class="status-badge status-active" style="margin-top: 0; white-space: nowrap;">In Progress</span>
        </div>

        <!-- Task Action Buttons -->
        <div class="task-actions" style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <% if (task.buttonText && task.buttonLink) { %>
                <a href="<%= task.buttonLink %>" 
                   target="_blank" 
                   class="btn btn-secondary"
                   onclick="trackTaskClick('<%= task._id %>')"
                   style="display: inline-flex; align-items: center; gap: 0.5rem; justify-content: center;">
                    <i class="fas fa-external-link-alt"></i> <%= task.buttonText %>
                </a>
            <% } %>
            
            <button 
                class="btn btn-primary" 
                onclick="openTaskModal('<%= task._id %>', '<%= quest._id %>', '<%= task.title.replace(/'/g, "\\'") %>', '<%= task.inputLabel || '' %>', '<%= task.inputName || '' %>', <%= !!task.buttonLink %>)"
                style="display: inline-flex; align-items: center; gap: 0.5rem; justify-content: center;">
                <i class="fas fa-paper-plane"></i> Submit Task
            </button>
        </div>
    </div>
    <% } %>
    <% }); %>
</div>

                <!-- Learning Resources -->
                <% if (quest.resources && quest.resources.length > 0) { %>
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-book"></i> Learning Resources</h3>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 0.8rem;">
                        <% quest.resources.forEach(function(resource) { %>
                        <a href="<%= resource.url %>" target="_blank" class="bounty-item" style="text-decoration: none; display: block;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <i class="fas fa-<%= resource.type === 'video' ? 'video' : resource.type === 'code' ? 'code' : 'file-alt' %>" style="color: #39FF14; font-size: 1.5rem;"></i>
                                <div style="flex: 1;">
                                    <div class="bounty-title"><%= resource.title %></div>
                                    <p style="color: #888; font-size: 0.85rem; margin-top: 0.3rem; text-transform: capitalize;"><%= resource.type %></p>
                                </div>
                                <i class="fas fa-external-link-alt" style="color: #666;"></i>
                            </div>
                        </a>
                        <% }); %>
                    </div>
                </div>
                <% } %>

                <!-- Leaderboard -->
                <% if (leaderboard && leaderboard.length > 0) { %>
<div class="card">
    <div class="card-header leaderboard-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
        <div>
            <h3><i class="fas fa-trophy"></i> Quest Leaderboard</h3>
            <span style="color: #888; font-size: 0.85rem;">Ranked by Total XP ‚Ä¢ <%= leaderboard.length %> Participants</span>
        </div>
        <div class="leaderboard-search" style="position: relative; flex: 1; max-width: 300px;">
            <input 
                type="text" 
                id="leaderboardSearch" 
                placeholder="Search by username..." 
                style="width: 100%; padding: 0.6rem 1rem 0.6rem 2.5rem; background: rgba(15,15,15,0.95); border: 1px solid rgba(57,255,20,0.2); border-radius: 12px; color: #fff; font-size: 0.85rem;"
                onkeyup="filterLeaderboard()"
            >
            <i class="fas fa-search" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #666;"></i>
        </div>
    </div>

    <!-- Top 3 Podium -->
    <div class="podium-container" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem; padding: 1rem; background: rgba(57,255,20,0.02); border-radius: 12px;">
        <% for(let i = 0; i < Math.min(3, leaderboard.length); i++) { 
            var entry = leaderboard[i];
            var totalXp = entry.xpBreakdown?.totalXp || entry.xpEarned || 0;
        %>
        <div class="podium-item" style="text-align: center; padding: 1rem; background: <%= i === 0 ? 'rgba(255,215,0,0.1)' : i === 1 ? 'rgba(192,192,192,0.1)' : 'rgba(205,127,50,0.1)' %>; border-radius: 12px; border: 1px solid <%= i === 0 ? '#FFD700' : i === 1 ? '#C0C0C0' : '#CD7F32' %>;">
            <div class="podium-rank" style="font-size: 2rem; margin-bottom: 0.3rem;"><%= i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : 'ü•â' %></div>
            <div style="color: #fff; font-weight: 600; font-size: 0.9rem; margin-bottom: 0.3rem; word-break: break-word;"><%= entry.userId?.username || 'Anonymous' %></div>
            <div style="color: #39FF14; font-weight: 700;"><%= totalXp %> XP</div>
            <div style="color: #666; font-size: 0.7rem; margin-top: 0.3rem;"><%= entry.timeSpentMinutes %>m</div>
        </div>
        <% } %>
    </div>

    <!-- Compact Scrollable List -->
    <div id="leaderboardList" style="max-height: 400px; overflow-y: auto; background: rgba(0,0,0,0.3); border-radius: 12px; padding: 0.5rem;">
    <% leaderboard.forEach(function(entry, idx) { 
        var totalXp = entry.xpBreakdown?.totalXp || entry.xpEarned || 0;
        var isCurrentUser = entry.userId?._id?.toString() === user?._id?.toString();
    %>
    <div class="leaderboard-row" data-username="<%= (entry.userId?.username || 'Anonymous').toLowerCase() %>" style="display: flex; align-items: center; justify-content: space-between; padding: 0.7rem 1rem; margin-bottom: 0.3rem; background: <%= isCurrentUser ? 'rgba(57,255,20,0.1)' : 'rgba(255,255,255,0.02)' %>; border-radius: 8px; border-left: 3px solid <%= entry.isWinner ? '#39FF14' : 'transparent' %>; transition: all 0.2s;">
        <div style="display: flex; align-items: center; gap: 1rem; flex: 1; min-width: 0;">
            <span class="rank" style="color: <%= idx < 3 ? (idx === 0 ? '#FFD700' : idx === 1 ? '#C0C0C0' : '#CD7F32') : '#888' %>; font-weight: 700; min-width: 35px; font-size: 0.9rem;">
                #<%= idx + 1 %>
            </span>
            <div style="flex: 1; min-width: 0;">
                <div class="user-info" style="color: #fff; font-weight: 500; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                    <span style="word-break: break-word;"><%= entry.userId?.username || 'Anonymous' %></span>
                    <% if (isCurrentUser) { %>
                        <span style="background: #39FF14; color: #000; padding: 0.1rem 0.4rem; border-radius: 4px; font-size: 0.65rem; font-weight: 700;">YOU</span>
                    <% } %>
                    <% if (entry.isWinner) { %>
                        <span style="color: #39FF14;">üèÜ</span>
                    <% } %>
                </div>
                <div class="user-meta" style="color: #666; font-size: 0.75rem;"><%= entry.timeSpentMinutes %>m ‚Ä¢ <%= Math.floor((Date.now() - new Date(entry.completedAt)) / (1000 * 60 * 60 * 24)) %>d ago</div>
            </div>
        </div>
        <div class="xp-info" style="text-align: right; flex-shrink: 0;">
            <div style="color: #39FF14; font-weight: 700; font-size: 1rem;"><%= totalXp %></div>
            <div style="color: #666; font-size: 0.7rem;">XP</div>
        </div>
    </div>
    <% }); %>
    </div>

                    <!-- Current User Progress -->
                    <% if (userProgress.status !== 'completed') { %>
                    <div style="padding: 1rem; text-align: center; color: #888; border-top: 2px solid rgba(57,255,20,0.2); margin-top: 1rem; background: rgba(57,255,20,0.05); border-radius: 12px;">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; flex-wrap: wrap;">
                            <div>
                                <strong style="color: #39FF14; font-size: 1rem;">Your Progress:</strong>
                                <span style="color: #fff; font-size: 1rem; margin-left: 0.5rem;"><%= userProgress.tasksCompleted %>/<%= quest.tasks.length %> Tasks (<%= userProgress.progress %>%)</span>
                            </div>
                            <% if (userProgress.startedAt) { %>
                            <div style="padding: 0 1rem; border-left: 1px solid rgba(57,255,20,0.3);">
                                <strong style="color: #888;">Time Spent:</strong>
                                <span style="color: #fff; margin-left: 0.5rem;"><%= Math.floor((Date.now() - new Date(userProgress.startedAt)) / 60000) %> min</span>
                            </div>
                            <% } %>
                        </div>
                        <p style="margin-top: 0.8rem; font-size: 0.85rem; color: #39FF14;">
                            <i class="fas fa-fire"></i> Complete remaining tasks to join the leaderboard!
                        </p>
                    </div>
                    <% } %>
                </div>
                <% } %>

                
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-chart-bar"></i> Quest Statistics</h3>
                    </div>
                    <div class="grid-3">
                        <div style="text-align: center; padding: 1rem; background: rgba(57,255,20,0.05); border-radius: 12px; border: 1px solid rgba(57,255,20,0.2);">
                            <div style="font-size: 2rem; color: #39FF14; font-weight: 700; margin-bottom: 0.5rem;"><%= quest.totalCompletions %></div>
                            <div style="color: #888; font-size: 0.85rem;">Total Completions</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: rgba(57,255,20,0.05); border-radius: 12px; border: 1px solid rgba(57,255,20,0.2);">
                            <div style="font-size: 2rem; color: #39FF14; font-weight: 700; margin-bottom: 0.5rem;"><%= quest.averageCompletionTime || 0 %>m</div>
                            <div style="color: #888; font-size: 0.85rem;">Average Time</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: rgba(57,255,20,0.05); border-radius: 12px; border: 1px solid rgba(57,255,20,0.2);">
                            <div style="font-size: 2rem; color: #39FF14; font-weight: 700; margin-bottom: 0.5rem;"><%= quest.totalAttempts > 0 ? Math.round((quest.totalCompletions / quest.totalAttempts) * 100) : 0 %>%</div>
                            <div style="color: #888; font-size: 0.85rem;">Success Rate</div>
                        </div>
                    </div>
                </div>

                <!-- Help & Support -->
                <div class="card"  style="background: linear-gradient(135deg, rgba(57,255,20,0.05) 0%, rgba(0,0,0,0.4) 100%); margin-bottom: 100px;">
                    <div style="text-align: center; padding: 1rem;">
                        <i class="fas fa-question-circle" style="color: #39FF14; font-size: 2.5rem; margin-bottom: 1rem;"></i>
                        <h3 style="margin-bottom: 0.5rem;">Need Help?</h3>
                        <p style="color: #888; margin-bottom: 1.5rem;">Join our Discord community for support and guidance</p>
                        <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                            <button class="btn btn-secondary">
                                <i class="fab fa-discord"></i> Join Discord
                            </button>
                            <button class="btn btn-secondary">
                                <i class="fas fa-comments"></i> Ask Question
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Task Submission Modal -->
    <div id="taskModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; justify-content: center; align-items: center; backdrop-filter: blur(4px);">
        <div class="modal-content" style="background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%); border-radius: 20px; padding: 2.5rem; max-width: 550px; width: 90%; border: 2px solid rgba(57,255,20,0.3); box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(57,255,20,0.2);">
                <div style="flex: 1; min-width: 0; padding-right: 1rem;">
                    <h3 id="taskModalTitle" style="margin: 0; color: #39FF14; font-size: 1.3rem; display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                        <i class="fas fa-paper-plane"></i> <span>Submit Task</span>
                    </h3>
                    <p style="color: #888; font-size: 0.85rem; margin: 0.5rem 0 0 0;">Complete the form below to submit your task</p>
                </div>
                <button class="close-btn" onclick="closeTaskModal()" style="background: rgba(255,255,255,0.05); border: none; color: #888; font-size: 1.8rem; cursor: pointer; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.3s; flex-shrink: 0;">&times;</button>
            </div>
            
            <form id="taskSubmitForm" class="modal-body">
                <div id="taskInputContainer" style="margin-bottom: 1.5rem;">
                    <!-- Dynamic input will be inserted here -->
                </div>
                
                <div class="modal-footer" style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid rgba(57,255,20,0.1); flex-wrap: wrap;">
                    <button type="button" class="btn btn-secondary" onclick="closeTaskModal()" style="padding: 0.8rem 1.5rem; flex: 1; min-width: 120px;">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" style="padding: 0.8rem 1.5rem; background: linear-gradient(135deg, #39FF14 0%, #2ecc11 100%); flex: 1; min-width: 120px;">
                        <i class="fas fa-check"></i> Submit Task
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentTaskId = null;
        let currentQuestId = null;
        let taskClickTracking = {};
        let taskStartTime = {};

        // Track when user clicks on task action button
        function trackTaskClick(taskId) {
            taskClickTracking[taskId] = Date.now();
            localStorage.setItem('taskClick_' + taskId, Date.now().toString());
        }

        // Check if user clicked the task button (within last 5 minutes)
        function hasClickedTaskButton(taskId) {
            const clickTime = taskClickTracking[taskId] || localStorage.getItem('taskClick_' + taskId);
            if (!clickTime) return false;
            
            const timeDiff = Date.now() - parseInt(clickTime);
            return timeDiff < 5 * 60 * 1000; // 5 minutes
        }

        // Track time spent on task
        function startTaskTimer(taskId) {
            taskStartTime[taskId] = Date.now();
        }

        function getTaskTimeSpent(taskId) {
            if (!taskStartTime[taskId]) return 0;
            return Math.floor((Date.now() - taskStartTime[taskId]) / 1000); // in seconds
        }

        function openTaskModal(taskId, questId, taskTitle, inputLabel, inputName, hasButton) {
            currentTaskId = taskId;
            currentQuestId = questId;
            
            // Start tracking time
            startTaskTimer(taskId);
            
            // Check if user clicked the task button (if task has a button)
            if (hasButton && !hasClickedTaskButton(taskId)) {
                showWarningModal(taskId, questId, taskTitle, inputLabel, inputName, hasButton);
                return;
            }
            
            document.getElementById('taskModalTitle').innerHTML = `<i class="fas fa-paper-plane"></i> <span>Submit: ${taskTitle}</span>`;
            
            const inputContainer = document.getElementById('taskInputContainer');
            
            if (inputLabel && inputName) {
                inputContainer.innerHTML = `
                    <div class="form-group">
                        <label for="taskInput">
                            <i class="fas fa-edit"></i> ${inputLabel}
                        </label>
                        <input 
                            type="text"
                            id="taskInput"
                            name="${inputName}"
                            placeholder="Enter ${inputLabel.toLowerCase()}"
                            required
                            minlength="3"
                        >
                        <small style="color: #666; font-size: 0.8rem; display: block; margin-top: 0.5rem;">
                            <i class="fas fa-info-circle"></i> Make sure to provide accurate information
                        </small>
                    </div>
                    
                    <!-- Hidden verification field -->
                    <input type="hidden" id="taskVerification" name="verification" value="${generateVerificationCode(taskId)}">
                `;
            } else {
                inputContainer.innerHTML = `
                    <div style="background: rgba(57,255,20,0.05); padding: 1rem; border-radius: 12px; border: 1px solid rgba(57,255,20,0.2); text-align: center;">
                        <i class="fas fa-check-circle" style="color: #39FF14; font-size: 2rem; margin-bottom: 0.5rem;"></i>
                        <p style="color: #ccc; margin: 0;">Click submit to complete this task</p>
                    </div>
                    <input type="hidden" id="taskVerification" name="verification" value="${generateVerificationCode(taskId)}">
                `;
            }
            
            document.getElementById('taskModal').style.display = 'flex';
            
            // Focus on input if exists
            setTimeout(() => {
                const input = document.getElementById('taskInput');
                if (input) input.focus();
            }, 100);
        }

        function showWarningModal(taskId, questId, taskTitle, inputLabel, inputName, hasButton) {
            const inputContainer = document.getElementById('taskInputContainer');
            
            document.getElementById('taskModalTitle').innerHTML = `<i class="fas fa-exclamation-triangle" style="color: #FFC107;"></i> <span>Action Required</span>`;
            
            inputContainer.innerHTML = `
                <div style="background: rgba(255,193,7,0.1); padding: 1.5rem; border-radius: 12px; border: 1px solid #FFC107; text-align: center;">
                    <i class="fas fa-hand-point-up" style="color: #FFC107; font-size: 3rem; margin-bottom: 1rem;"></i>
                    <h4 style="color: #FFC107; margin-bottom: 1rem;">Complete the Task First!</h4>
                    <p style="color: #ccc; line-height: 1.6; margin-bottom: 1.5rem;">
                        Before submitting, you need to click the task button and complete the required action. 
                        This ensures you've actually performed the task.
                    </p>
                    <div style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <p style="color: #888; font-size: 0.85rem; margin-bottom: 0.5rem;">
                            <i class="fas fa-lightbulb"></i> <strong>Steps to complete:</strong>
                        </p>
                        <ol style="color: #ccc; text-align: left; font-size: 0.85rem; padding-left: 1.5rem; margin: 0;">
                            <li style="margin-bottom: 0.5rem;">Click the task action button above</li>
                            <li style="margin-bottom: 0.5rem;">Complete the required task</li>
                            <li>Return and click "Submit Task"</li>
                        </ol>
                    </div>
                    <button 
                        class="btn btn-primary" 
                        onclick="closeTaskModal()"
                        style="margin-top: 1rem; width: 100%;">
                        <i class="fas fa-arrow-left"></i> Got it! Let me do the task first
                    </button>
                </div>
            `;
            
            document.getElementById('taskModal').style.display = 'flex';
            
            // Hide the submit button in modal footer
            const modalFooter = document.querySelector('.modal-footer');
            modalFooter.style.display = 'none';
            
            setTimeout(() => {
                modalFooter.style.display = 'flex';
            }, 1000);
        }

        function generateVerificationCode(taskId) {
            // Simple verification code based on task ID and timestamp
            const timestamp = Date.now();
            return btoa(taskId + ':' + timestamp).substr(0, 20);
        }

        function closeTaskModal() {
            document.getElementById('taskModal').style.display = 'none';
            document.getElementById('taskSubmitForm').reset();
            currentTaskId = null;
            currentQuestId = null;
        }

        // Leaderboard search function
        function filterLeaderboard() {
            const searchInput = document.getElementById('leaderboardSearch');
            const filter = searchInput.value.toLowerCase();
            const rows = document.querySelectorAll('.leaderboard-row');
            
            let visibleCount = 0;
            rows.forEach(row => {
                const username = row.getAttribute('data-username');
                if (username.includes(filter)) {
                    row.style.display = 'flex';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Show "no results" message if needed
            const leaderboardList = document.getElementById('leaderboardList');
            let noResultsMsg = document.getElementById('noResultsMsg');
            
            if (visibleCount === 0 && filter !== '') {
                if (!noResultsMsg) {
                    noResultsMsg = document.createElement('div');
                    noResultsMsg.id = 'noResultsMsg';
                    noResultsMsg.style.cssText = 'text-align: center; padding: 2rem; color: #888;';
                    noResultsMsg.innerHTML = '<i class="fas fa-search" style="font-size: 2rem; margin-bottom: 0.5rem; display: block;"></i>No users found matching "' + filter + '"';
                    leaderboardList.appendChild(noResultsMsg);
                }
            } else if (noResultsMsg) {
                noResultsMsg.remove();
            }
        }

        // Handle task submission
        document.getElementById('taskSubmitForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!currentTaskId || !currentQuestId) {
                alert('Error: Task information missing');
                return;
            }

            // Check time spent (at least 5 seconds)
            const timeSpent = getTaskTimeSpent(currentTaskId);
            if (timeSpent < 5) {
                alert('‚è±Ô∏è Please take a moment to review the task requirements before submitting.');
                return;
            }
            
            const formData = new FormData(this);
            const submitData = {
                questId: currentQuestId,
                taskId: currentTaskId,
                submissionUrl: formData.get('submissionUrl') || '',
                submissionText: formData.get('submissionText') || '',
                submissionData: {},
                verification: formData.get('verification') || '',
                timeSpent: timeSpent
            };
            
            // Collect all form data
            for (let [key, value] of formData.entries()) {
                if (key !== 'submissionUrl' && key !== 'submissionText' && key !== 'verification') {
                    submitData.submissionData[key] = value;
                }
            }

            // Show loading state
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
            submitBtn.disabled = true;

            try {
                const response = await fetch('/dashboard/quests/submit-task', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(submitData)
                });

                const data = await response.json();

                if (data.success) {
                    // Clear tracking
                    localStorage.removeItem('taskClick_' + currentTaskId);
                    delete taskClickTracking[currentTaskId];
                    delete taskStartTime[currentTaskId];
                    
                    closeTaskModal();
                    
                    if (data.isQuestCompleted) {
                        let message = 'üéâ Quest Completed! You earned ' + data.rewards.xp + ' XP';
                        if (data.rewards.usdc > 0) {
                            message += ' and ' + data.rewards.usdc + ' USDC';
                        }
                        message += '!';
                        alert(message);
                    } else {
                        alert('‚úÖ Task submitted successfully!');
                    }
                    
                    window.location.reload();
                } else {
                    alert(data.message || 'Failed to submit task');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            } catch (error) {
                console.error('Error submitting task:', error);
                alert('Error submitting task. Please try again.');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // Close modal on background click
        document.getElementById('taskModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeTaskModal();
            }
        });

        // Close modal on ESC key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('taskModal').style.display === 'flex') {
                closeTaskModal();
            }
        });

        function handleLogout(event) {
            event.preventDefault();
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = '/auth/logout';
            }
        }

        // Animate progress bar on load
        window.addEventListener('load', function() {
            var progressBar = document.querySelector('.progress-bar');
            if (progressBar) {
                var width = progressBar.style.width;
                progressBar.style.width = '0%';
                setTimeout(function() {
                    progressBar.style.width = width;
                }, 100);
            }

            // Scroll to current user in leaderboard if completed
            setTimeout(() => {
                const currentUserRow = document.querySelector('.leaderboard-row[style*="rgba(57,255,20,0.1)"]');
                if (currentUserRow) {
                    currentUserRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 500);
        });
    </script>
</body>
</html>